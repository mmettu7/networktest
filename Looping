---
- name: Unbind and Disable CSVservers and LBVservers on Netscaler
  hosts: localhost
  gather_facts: no

  vars:
    netscaler_ip: "your_netscaler_ip"
    netscaler_username: "your_netscaler_username"
    netscaler_password: "your_netscaler_password"
    csvservers:
      - name: "csvserver1"
      - name: "csvserver2"
    lbvservers:
      - name: "lbvserver1"
      - name: "lbvserver2"

  tasks:
    - name: Unbind CSVservers from LBVservers and Disable them
      block:
        - name: Unbind CSVserver from LBVserver and Disable them
          uri:
            url: "http://{{ netscaler_ip }}/nitro/v1/config/csvserver_lbvserver_binding/{{ item.csvserver.name }}"
            method: DELETE
            headers:
              Accept: "application/json"
            user: "{{ netscaler_username }}"
            password: "{{ netscaler_password }}"
            status_code: 200
            validate_certs: no
          loop: "{{ csvservers }}"
          register: unbind_result_csv

        - name: Disable CSVservers
          uri:
            url: "http://{{ netscaler_ip }}/nitro/v1/config/csvserver/{{ item.name }}"
            method: PUT
            headers:
              Accept: "application/json"
              Content-Type: "application/json"
            user: "{{ netscaler_username }}"
            password: "{{ netscaler_password }}"
            body_format: json
            body:
              csvserver:
                name: "{{ item.name }}"
                state: "DISABLED"
            status_code: 200
            validate_certs: no
          loop: "{{ csvservers }}"
          when: unbind_result_csv | length > 0

        - name: Disable LBVservers
          uri:
            url: "http://{{ netscaler_ip }}/nitro/v1/config/lbvserver/{{ item.name }}"
            method: PUT
            headers:
              Accept: "application/json"
              Content-Type: "application/json"
            user: "{{ netscaler_username }}"
            password: "{{ netscaler_password }}"
            body_format: json
            body:
              lbvserver:
                name: "{{ item.name }}"
                state: "DISABLED"
            status_code: 200
            validate_certs: no
          loop: "{{ lbvservers }}"
          when: unbind_result_csv | length > 0
